# Global default settings.
global {
  scrape_interval: "15s"     # By default, scrape targets every 15 seconds.
  evaluation_interval: "15s" # By default, evaluate rules every 15 seconds.

  # Attach these extra labels to all timeseries collected by this Prometheus instance.
  labels: {
    label: {
      name: "monitor"
      value: "gluu-monitor"
    }
  }

  # Load and evaluate rules in this file every 'evaluation_interval' seconds. This field may be repeated.
  #rule_file: "prometheus.rules"
}

# A job definition containing exactly one endpoint to scrape: Here it's prometheus itself.
job: {
  # The job name is added as a label `job={job-name}` to any timeseries scraped from this job.
  name: "prometheus"
  # Override the global default and scrape targets from this job every 5 seconds.
  scrape_interval: "15s"

  # Let's define a group of targets to scrape for this job. In this case, only one.
  target_group: {
    # These endpoints are scraped via HTTP.
    target: "http://localhost:9090/metrics"
  }
}

{% for cluster in clusters %}
{% set ldaps = cluster.get_ldap_objects() %}
{% set oxauths = cluster.get_oxauth_objects() %}
{% set oxtrusts = cluster.get_oxtrust_objects() %}
{% set httpds = cluster.get_httpd_objects() %}
job: {
  name: "{{cluster.name}}-container-metrics-collector"
  scrape_interval: "15s"

  # The targets for this job.
  {% if ldaps is defined %}
  {% set type = ldaps[0].type %}
  target_group: { {% for ldap in ldaps %}
    target: "http://{{ ldap.weave_ip }}:9100/metrics"{% endfor %}
    labels: {
    label: {
        name: "type"
        value: "{{ type }}"
      }
      label: {
        name: "cluster"
        value: "{{ cluster.name }}"
      }
    }
  }
  {% endif %}
  {% if oxauths is defined %}
  {% set type = oxauths[0].type %}
  target_group: { {% for oxauth in oxauths %}
    target: "http://{{ oxauth.weave_ip }}:9100/metrics"{% endfor %}
    labels: {
    label: {
        name: "type"
        value: "{{ type }}"
      }
      label: {
        name: "cluster"
        value: "{{ cluster.name }}"
      }
    }
  }
  {% endif %}
  {% if oxtrusts is defined %}
  {% set type = oxtrusts[0].type %}
  target_group: { {% for oxtrust in oxtrusts %}
    target: "http://{{ oxtrust.weave_ip }}:9100/metrics"{% endfor %}
    labels: {
    label: {
        name: "type"
        value: "{{ type }}"
      }
      label: {
        name: "cluster"
        value: "{{ cluster.name }}"
      }
    }
  }
  {% endif %}
  {% if httpds is defined %}
  {% set type = httpds[0].type %}
  target_group: { {% for httpd in httpds %}
    target: "http://{{ httpd.weave_ip }}:9100/metrics"{% endfor %}
    labels: {
    label: {
        name: "type"
        value: "{{ type }}"
      }
      label: {
        name: "cluster"
        value: "{{ cluster.name }}"
      }
    }
  }
  {% endif %}
}
{% endfor %}